---
defaults: &defaults
  docker:
    - image: docker:stable-git

version: 2
jobs:
  test:
    <<: *defaults

    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: "Build container"
          command: |
              set +e
              git clone https://${GH_TOKEN}@github.com/NCAR/sweet.git $HOME/sweet
              $HOME/sweet/docker-build --show

      - run:
          name: "Run tests"
          command: |
              set +e
              cd sbin
              nohup ./run-test-server </dev/null >../../test-server.log 2>&1 &
              sleep 2
              ./run-test-client
              cat ../../test-server.log
              exit 0


workflows:
  version: 2
  test-push:
    jobs:
      - test:
          context: sweg
