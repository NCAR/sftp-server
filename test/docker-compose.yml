version: '3.6'

services:

  server:
    image: ncar/sftp-server:latest
    init: true
    volumes:
      - type: volume
        source: testdata
        target: ${DATA_DIR}
      - type: bind
        read_only: "true"
        source: ${LOCAL_SECRETS}
        target: ${SECRETS_VOL}
      - type: tmpfs
        target: /tmp
    environment:
      SERVICE: server
      RUN_ENV: test
      ENTRYPOINT_DEBUG:
    networks:
      - sftp

  client:
    image: ncar/sftp-server:latest
    user: ${SWEETUSER}:${SFTPGROUP}
    entrypoint: [ "/usr/local/sweet/sbin/sweet-entrypoint.sh", "--source=/usr/local/sftp-server/sbin/sftp-cl-entrypoint.rc" ]
    command: [ "/usr/local/sftp-server/tbin/sftp-client-shell" ]
    volumes:
      - type: volume
        source: testdata
        target: ${DATA_DIR}
      - type: bind
        read_only: "true"
        source: ${LOCAL_SECRETS}
        target: ${SECRETS_VOL}
      - type: tmpfs
        target: /tmp
    environment:
      SERVICE: client
      RUN_ENV: test
      SFTP_SERVER: server
      INTERACTIVE: 0
      ENTRYPOINT_DEBUG: 0
    networks:
      - sftp

  reset-server-keys:
    image: ncar/sftp-server:latest
    entrypoint: [ "/usr/local/sweet/sbin/sweet-entrypoint.sh" ]
    command: [ "/usr/local/sftp-server/sbin/ssh-keysync" ]
    volumes:
      - type: bind
        source: ${LOCAL_SECRETS}
        target: ${DATA_DIR}
    environment:
      SERVICE: server
      RUN_ENV: test
      ENTRYPOINT_DEBUG:
    profiles: [ "reset-keys" ]

  reset-client-keys:
    image: ncar/sftp-server:latest
    user: ${SWEETUSER}:${SWEETGROUP}
    entrypoint: [ "/usr/local/sweet/sbin/sweet-entrypoint.sh" ]
    command: [ "/usr/local/sftp-server/sbin/ssh-keysync" ]
    volumes:
      - type: bind
        source: ${LOCAL_SECRETS}
        target: ${DATA_DIR}
    environment:
      SERVICE: client
      RUN_ENV: test
      ENTRYPOINT_DEBUG:
    profiles: [ "reset-keys" ]

volumes:
  testdata:
  
networks:
  sftp:

volumes:
  testdata:
  
networks:
  sftp:

